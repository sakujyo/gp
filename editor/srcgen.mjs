var srcgen="var content = ce('div')\r\nvar queryword = ce('input')\r\nvar searchresult = ce('div')\r\nvar body = document.body\r\nvar items, favs\r\nvar keywords = ''\r\nvar page\r\nconst FAVORITE = 'favorite'\r\nconst FAVIDS = 'favids'\r\nconst FAVLIST = 'favlist'\r\n\r\nfunction queryhandler(e) {\r\n\tswitch (e.key) {\r\n\t\tcase 'Enter':\r\n\t\t\tkeywords = queryword.value\r\n\t\t\tpage = 1\r\n\t\t\tshowsearchresult(queryword.value) // not need page if page == 1\r\n\t\t\tbreak\r\n\t\tcase 'n':\r\n\t\tcase '/':\r\n\t\tcase 'f':\r\n\t\t\te.preventDefault\r\n\t\t\tbreak\r\n\t}\r\n}\r\n\r\nconst stylesheet = new CSSStyleSheet\r\nstylesheet.replaceSync(\r\n`body {\r\n\tbackground-color: #232323;\r\n\tcolor: white;\r\n}\r\n\r\n.price {\r\n\tbackground-color: #800764;\r\n}\r\n.mem32g {\r\n\tbackground-color: #e00009;\r\n}\r\n.mem16g {\r\n\tbackground-color: #cf1057;\r\n}\r\n.mem8g {\r\n\tbackground-color: #880f3c;\r\n}\r\n.ssd1T {\r\n\tbackground-color: #d9b209;\r\n}\r\n.ssd512 {\r\n\tbackground-color: #7d36a4;\r\n}\r\n.ssd256 {\r\n\tbackground-color: #202074;\r\n}\r\n.g128 {\r\n\tbackground-color: #13134c;\r\n}\r\n`)\r\ndocument.adoptedStyleSheets = [ stylesheet ]\r\n\r\nfunction styleitemname(s) {\r\n\t//console.log(styleitemname('abc256gxy'))\r\n\treturn s\r\n\t\t.replace(/(?<= )1T/i, m => `<span class=\"ssd1T\">${m}</span>`)\r\n\t\t.replace(/(?<= )32G/i, m => `<span class=\"mem32g\">${m}</span>`)\r\n\t\t.replace(/(?<= )16G/i, m => `<span class=\"mem16g\">${m}</span>`)\r\n\t\t.replace(/(?<= )8G/i, m => `<span class=\"mem8g\">${m}</span>`)\r\n\t\t.replace(/(?<= )512G/i, m => `<span class=\"ssd512\">${m}</span>`)\r\n\t\t.replace(/(?<= )256G/i, m => `<span class=\"ssd256\">${m}</span>`)\r\n\t\t.replace(/(?<= )128G/i, m => `<span class=\"g128\">${m}</span>`)\r\n}\r\n\r\nfunction styleitem(x) {\r\n\tconst id = x.url.match(/CODE=(\\d+)/)[1]\r\n\treturn `<div class=\"item\"><input type=\"checkbox\" class=\"fav\" id=\"${id}\"${\r\n\t\tfavs.get(id) ? ' checked' : ''\r\n\t}><span class=\"price\">${x.price}</span> <a href=\"https://www.janpara.co.jp\\/\\/sale\\/search\\/detail\\/\\?${x.url}\">${\r\n\t\tx.url.match(/(.*?)CODE/)[1][0]\r\n\t}</a> ${styleitemname(x.itemname)}</div>`\r\n}\r\n\r\nconst handlerfav = (x) => {\r\n\t\tx.onchange = async (e) => {\r\n\t\t\tconst item = items.find(x => x.url.match(RegExp(`(SR|ITM)CODE=${e.target.id}`)))\r\n\t\t\ttry {\r\n\t\t\t\tawait fetch(FAVORITE, {\r\n\t\t\t\t\tmethod: 'POST',\r\n\t\t\t\t\theaders: {\r\n\t\t\t\t\t\t'Content-Type': 'application/json;charset=utf8',\r\n\t\t\t\t\t},\r\n\t\t\t\t\tbody: JSON.stringify(item)\r\n\t\t\t\t})\r\n\t\t\t\tfavs.set(e.target.id, true)\r\n\t\t\t} catch(err) {\r\n\t\t\t\te.target.checked = false\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\nasync function showfavs(keywords) {\r\n\tsearchresult.innerHTML = ''\r\n\tconst res = await fetch(FAVLIST)\r\n\tconst items = (await res.json())\r\n\t\t.data\r\n\t\t.sort((a, b) => a.price - b.price)\r\n\tif (items == null) {\r\n\t\tsearchresult.innerHTML = 'NOT FOUND'\r\n\t\treturn\r\n\t}\r\n\tsearchresult.innerHTML = items\r\n\t\t.map(styleitem)\r\n\t\t.join('')\r\n\tdocument.querySelectorAll('.fav').forEach(handlerfav)\r\n\tqueryword.blur()\r\n}\r\n\r\nasync function showsearchresult(keywords, page) {\r\n\tsearchresult.innerHTML = ''\r\n\titems = await search(keywords, page)\r\n\tif (items == null) {\r\n\t\tsearchresult.innerHTML = 'NOT FOUND'\r\n\t\treturn\r\n\t}\r\n\tsearchresult.innerHTML = items\r\n\t\t.map(styleitem)\r\n\t\t.join('')\r\n\tdocument.querySelectorAll('.fav').forEach(handlerfav)\r\n\tqueryword.blur()\r\n}\r\n\r\nfunction fetchpage({ keywords, order = 3, line = 24, page }) {\r\n\treturn fetch(`fetch?KEYWORDS=${keywords}&ORDER=${order}&LINE=${line}${\r\n\t\tpage ? `&PAGE=${page}` : ''}`)\r\n}\r\n\r\n//function url({ keywords, order = 3, line = 24, page }) {\r\n//\tconsole.log(order, line, page)\r\n//\t//console.log(url({ keywords: 'x280', order: 2}))\r\n//\t//2 24 undefined\r\n//\t//https://www.janpara.co.jp/sale/search/result/?KEYWORDS=x280&ORDER=2&LINE=24\r\n//\treturn `https://www.janpara.co.jp/sale/search/result/?KEYWORDS=${keywords}&ORDER=${order}&LINE=${line}${\r\n//\t\tpage ? `&PAGE=${page}` : ''}`\r\n//}\r\n\r\n//(() => {\r\nfunction parsePrice(s) {\r\n\treturn s ? parseInt(\r\n\t\ts.replace(/ï½ž/g, '')\r\n\t)\r\n\t: s\r\n}\r\nfunction item(x) {\r\n\tfunction price(x) {\r\n\t\tconst m = x.match(/<div class=\"item_amount\">\\s*(.*?)<\\/div>/s)\r\n\t\treturn m ? m[1].trim().replace(/(&yen;|,)/g, '') : m\r\n\t}\r\n\treturn {\r\n\t\turl: x.match(/\x3ca class=\"search_itemlink\" href=\"\\/sale\\/search\\/detail\\/\\?((SRCODE|ITMCODE)=(.*?))\">/)[1], \r\n\t\turlimage: x.match(/<div class=\"search_itemimage\">\\s*<img src=\".*?\\/images\\/(.*?)\".*?alt=\"(.*?)\" \\/>/)[1],\r\n\t\titemname: x.match(/<div class=\"search_itemname.*?>(.*?)<\\/div>/s)[1].trim(),\r\n\t\tamount: x.match(/<div class=\"search_itemprice\">\\s*<div(?<soldout> class=\"search_nostock\")?>(.*?)<\\/div>/s)[2].trim(),\r\n\t\tcondition: x.match(/<div class=\"search_itemcondition\">\\s*(.*?)<\\/div>/)?.[1],\r\n\t\tprice: parsePrice(price(x)),\r\n\t\tpricestr: price(x),\r\n\t}\r\n}\r\n\r\nasync function search(keywords, page = undefined) {\r\n\t//const res = await fetch(url({ keywords }))\r\n\tconst res = await fetchpage({ keywords, page })\r\n\tconst text = await res.text()\r\n\t//console.log(text)\r\n\tif (text.match(/class=\"sorry\"/)) return null\r\n\tconst items = text.match(/<div class=\"search_item_s(.*?)\">(.*?)\\x3C!-- search_item end-->/gs)\r\n\t\t.map(x => item(x))\r\n\treturn items\r\n\tdebugger\r\n}\r\n\r\nfunction buildui() {\r\n\t//content.id = 'content'\r\n\tqueryword.onkeydown = queryhandler\r\n\tcontent.appendChild(queryword)\r\n\tcontent.appendChild(searchresult)\r\n\tbody.appendChild(content)\r\n\tdocument.body.onkeydown = e => {\r\n\t\tswitch (e.key) {\r\n\t\t\tcase '/':\r\n\t\t\t\te.preventDefault()\r\n\t\t\t\tqueryword.focus()\r\n\t\t\t\tbreak\r\n\t\t\tcase 'f':\r\n\t\t\t\tif (e.ctrlKey) return\r\n\t\t\t\tshowfavs()\r\n\t\t\t\tbreak\r\n\t\t\tcase 'n':\r\n\t\t\t\tif (keywords === '') return\r\n\t\t\t\tpage = 1 < page ? page + 1 : 2\r\n\t\t\t\tshowsearchresult(keywords, page)\r\n\t\t\t\tbreak\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction ce(name) {\r\n\treturn document.createElement(name)\r\n}\r\n\r\nasync function main() {\r\n\tfavs = new Map()\r\n\tconst res = await fetch(FAVIDS)\r\n\tconst favlist = await res.json()\r\n\tfavlist.data.forEach(x => favs.set(x, true))\r\n\tbuildui()\r\n\t//showsearchresult('x13')\r\n\tshowfavs()\r\n}\r\nmain()\r\n"
